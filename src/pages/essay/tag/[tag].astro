---
import type { CollectionEntry } from 'astro:content'
import { getCollection } from 'astro:content'
import PostListLayout from '../../../layouts/PostList.astro'

export async function getStaticPaths() {
  const posts = await getCollection('essay')

  const tagsMap = posts.reduce((acc, post) => {
    post.data.tags?.forEach(tag => {
      if (!acc[tag]) {
        acc[tag] = []
      }
      acc[tag].push(post)
    })
    return acc
  }, {} as Record<string, CollectionEntry<'essay'>[]>)

  return Object.keys(tagsMap).map(tag => {
    tagsMap[tag].sort((a, b) => {
      const aDate = a.data.update || a.data.date
      const bDate = b.data.update || b.data.date
      return bDate.valueOf() - aDate.valueOf()
    })

    return {
      params: { tag },
      props: { posts: tagsMap[tag] },
    }
  })
}

const posts: CollectionEntry<'essay'>[] = Astro.props.posts
---
<PostListLayout posts={posts}></PostListLayout>
